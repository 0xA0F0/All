let firebaseConfig={apiKey:"AIzaSyCkvaWekEMMk0y43Nf744KRaH9QYd3Hj6I",authDomain:"test-71cc8.firebaseapp.com",databaseURL:"https://test-71cc8-default-rtdb.europe-west1.firebasedatabase.app",projectId:"test-71cc8",storageBucket:"test-71cc8.appspot.com",messagingSenderId:"911748905714",appId:"1:911748905714:web:ad42c0b23920a5f9bd6e6b",measurementId:"G-FZ0SC6YJJB"};import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAnalytics as t}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js";import{getDatabase as n,ref as a,push as i,onValue as s,remove as l,update as r}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";let app=e(firebaseConfig),analytics=t(app),database=n(),commentForm=document.getElementById("commentForm"),commentInput=document.getElementById("commentInput"),commentsBlock=document.getElementById("commentsBlock"),loadMoreButton=document.createElement("span");loadMoreButton.textContent="Еще",loadMoreButton.classList.add("load-more-button"),document.querySelector(".main").insertBefore(loadMoreButton,commentsBlock);let comments=[],commentLimit=5;function displayComment(e){let t=document.createElement("div");t.id=`comment-${e.key}`,t.classList.add("comment"),t.setAttribute("data-key",e.key);let n=document.createElement("div");if(n.classList.add("appear"),!document.querySelector("form.login")){let a=document.createElement("button");a.classList.add(...["edit-button","mdi","mdi-lead-pencil"]),a.addEventListener("click",()=>displayEditForm(e.key)),n.appendChild(a);let i=document.createElement("button");i.classList.add("delete","mdi","mdi-close"),i.addEventListener("click",()=>deleteComment(e.key)),n.appendChild(i)}t.appendChild(n);let s=document.createElement("img");s.src="/img/ava.webp",s.alt="pirate",t.appendChild(s);let l=document.createElement("span");l.textContent="0xA9F9",l.classList.add("nickname"),t.appendChild(l);let r=document.createElement("span");r.textContent=formatTimeDifference(e.date),r.classList.add("date"),t.appendChild(r);let o=document.createElement("div");if(o.classList.add("cmt"),o.innerHTML=parseCommentText(e.text),t.appendChild(o),e.edited){let c=document.createElement("span");c.classList.add("edited");let d=new Date(e.edited);c.innerHTML=`<span class="e-date">${d.toLocaleString()}</span> <span class="mdi mdi-lead-pencil"></span>`,t.appendChild(c)}if(t.querySelectorAll("code").forEach(e=>{hljs.highlightBlock(e)}),commentsBlock.appendChild(t),o.clientHeight>200){let m=document.createElement("div");m.innerHTML='<span class="mdi mdi-arrow-down">развернуть</span>',m.addEventListener("click",()=>{o.style.maxHeight="none",m.style.display="none"}),m.classList.add("more-text"),t.appendChild(m),o.style.maxHeight="200px",o.style.overflow="hidden"}}function editComment(e,t){let n=a(database,`comments/${e}`);r(n,{text:t,edited:new Date().toLocaleString()})}function displayEditForm(e){let t=document.getElementById(`comment-${e}`),n=t.querySelector(".cmt").innerHTML,a=document.createElement("form");a.innerHTML=`
          <textarea rows="10" name="text" id="editCommentText" style="width: 100%; resize: block; overflow-wrap: break-word; padding: 5px; background: var(--edit-t); border-radius:3px;">${n}</textarea>
        <div class="b-edite">
            <button type="submit">Сохранить</button>
            <button type="button" class="cancelEdit">Отмена</button>
        </div>
    `,t.querySelectorAll(".comment > *").forEach(e=>{e.style.display="none"}),t.appendChild(a),a.addEventListener("submit",function(n){n.preventDefault();let i=a.querySelector("#editCommentText").value;editComment(e,i),t.querySelector(".cmt").innerText=i,a.remove(),t.querySelectorAll(".comment > *").forEach(e=>{e.style.display=""})}),a.querySelector(".cancelEdit").addEventListener("click",function(){a.remove(),t.querySelectorAll(".comment > *").forEach(e=>{e.style.display=""})})}function displayComments(){commentsBlock.innerHTML="";comments.slice(0,commentLimit).reverse().forEach(displayComment),commentLimit>=comments.length?loadMoreButton.style.display="none":loadMoreButton.style.display="inline"}function parseCommentText(e){e=(e=e.replace(/\[span=([^\]]+)\]([\s\S]*?)\[\/span\]/g,'<span class="$1">$2</span>')).replace(/\[div=([^\]]+)\]([\s\S]*?)\[\/div\]/g,'<div class="$1">$2</div>');let t=[];return e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\[code=([a-zA-Z0-9\+\-\#]+)]([\s\S]*?)\[\/code]/g,function(e,n,a){return n=n.replace("c++","cpp"),a=(a=a.replace(/\[code=([a-zA-Z0-9\+\-\#]+)]([\s\S]*?)\[\/code]/g,function(e,t,n){return"[code="+t+"]"+n+"[/code]"})).replace(/</g,"&lt;").replace(/>/g,"&gt;"),t.push({lang:n,code:a}),"\x01"+(t.length-1)+"\x01"})).replace(/\[hr\]/g,"<hr>")).replace(/\[right\]([\s\S]*?)\[\/right\]/g,'<div class="right">$1</div>')).replace(/\[center\]([\s\S]*?)\[\/center\]/g,'<div class="center">$1</div>')).replace(/\[img=([^\s]+)(?:\s+w=(\d+))?(?:\s+h=(\d+))?\]/g,function(e,t,n,a){return n&&a?'<img src="'+t+'" alt="img" style="width: '+n+"px; height: "+a+'px;">':'<img src="'+t+'" alt="img">'})).replace(/\[_list([\s\S]*?)\]/g,function(e,t){var n=t.trim().split("\n"),a='<ul class="list">';return n.forEach(function(e){a+="<li>"+e.trim()+"</li>"}),a+="</ul>"})).replace(/\[spoiler=(.*?)\]([\s\S]*?)\[\/spoiler\]/g,function(e,t,n){return'<div class="spoil"><div class="title">'+t+'</div><div class="content">'+n+"</div></div>"})).replace(/\[url=([^\]]+)\]([^\[]+)\[\/url\]/g,'<a href="$1" target="_blank">$2</a>')).replace(/\[video\]([^\[]+)\[\/video\]/g,function(e,t){var n=t.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/)[1];return'<div class="video-container"><img src="https://img.youtube.com/vi/'+n+'/maxresdefault.jpg" class="preview-img" /><iframe src="https://www.youtube.com/embed/'+n+'" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="display:none;"></iframe></div>'}),document.addEventListener("click",function(e){var t=e.target;t.classList.contains("video-container")&&(t.querySelector(".preview-img").style.display="none",t.querySelector("iframe").style.display="block",t.classList.add("off"))}),document.querySelector(".comments")&&document.getElementById("preview").addEventListener("click",function(e){var t=e.target;t.classList.contains("video-container")&&(t.querySelector(".preview-img").style.display="none",t.querySelector("iframe").style.display="block",t.classList.add("off"))}),e=(e=e.replace(/\n/g,"<br>")).replace(/\x01(\d+)\x01/g,function(e,n){let a=t[n];return'<pre  id="code"class="this-code flex column"><div class="code-itm"><span class="lang">'+a.lang+'</span></div> <code class="kod language-'+a.lang+'">'+a.code.trim()+"</code></pre>"})}document.addEventListener("click",function(e){var t=e.target,n=t.closest(".title"),a=t.closest("#preview");n&&!a&&n.classList.toggle("jez")}),document.getElementById("preview").addEventListener("click",function(e){var t=e.target.closest(".title");t&&t.classList.toggle("jez")});let isPreviewVisible=!1;function deleteComment(e){let t=a(database,`comments/${e}`);l(t)}function formatTimeDifference(e){let t=new Date,n=t-new Date(e),a=Math.floor(n/1e3),i=Math.floor(a/60),s=Math.floor(i/60),l=Math.floor(s/24),r=Math.floor(l/7),o=Math.floor(l/30),c=Math.floor(l/365);if(c>0)return 1===c?"год назад":`${c} ${c%10==2||c%10==3||c%10==4?"года":"лет"} назад`;if(o>0)return 1===o?"месяц назад":`${o} ${o%10==1?"месяц":"месяца"} назад`;if(r>0)return 1===r?"неделю назад":`${r} ${r%10==1?"неделю":"недели"} назад`;if(l>0)return 1===l?"вчера":`${l} ${l%10==1?"день":"дня"} назад`;if(s>0)return 1===s?"час назад":`${s} ${s%10==1?"час":"часа"} назад`;else if(i>0)return 1===i?"минуту назад":`${i} ${i%10==1?"минуту":"минуты"} назад`;else if(a>0)return 1===a?"секунду назад":`${a} ${a%10==1?"секунду":"секунды"} назад`;else return"только что"}function sendComment(e){if(""!==e.text.trim()){a(database,"comments");let t={text:e.text,date:new Date().toISOString()},n=a(database,`comments/${Date.now().toString()}`);r(n,t)}}document.getElementById("b-preview").addEventListener("click",function(){let e=document.getElementById("commentInput"),t=document.getElementById("preview");if(isPreviewVisible)e.style.display="block",t.style.display="none",isPreviewVisible=!1;else{let n=e.value,a=parseCommentText(n);t.innerHTML=a,e.style.display="none",t.style.display="block",isPreviewVisible=!0}}),loadMoreButton.addEventListener("click",()=>{commentLimit+=10,displayComments()}),s(a(database,"comments"),e=>{comments=[],e.forEach(e=>{let t=new Date(e.val().date),n={key:e.key,text:e.val().text,date:t,edited:e.val().edited};comments.push(n)}),comments.reverse(),displayComments()}),commentForm.addEventListener("submit",e=>{e.preventDefault();let t=commentInput.value.trim();if(""!==t)sendComment({text:t}),commentInput.value="";else{let n=document.createElement("span");n.className="error",n.textContent="текст не может быть пустым",commentForm.appendChild(n),setTimeout(()=>{n.remove()},3e3)}});let searchInput=document.getElementById("searchInput");function displayFilteredComments(e){let t=comments.filter(t=>{let n=RegExp(e,"i");return n.test(t.text.toLowerCase())||n.test(t.key)});commentsBlock.innerHTML="",t.slice(0,commentLimit).forEach(displayComment),commentLimit>=t.length?loadMoreButton.style.display="none":loadMoreButton.style.display="inline"}searchInput.addEventListener("input",function(){let e=searchInput.value.toLowerCase();""===e?displayComments():displayFilteredComments(e)});
